# JTL Workflow Automator 使用指南

## 简介

JTL Workflow Automator 是一个专为 JTL-Wawi 和 JTL-Shop 电商运营设计的自动化工作流框架。它提供了一套完整的工具和模板，帮助你快速构建订单处理、库存管理、产品数据同步、报表生成等自动化流程。

### 为什么需要这个技能？

在日常电商运营中，你可能经常遇到这些场景：

- 每天手动检查库存，发现缺货才去补货
- 订单从多个渠道（Shop、eBay、Conrad）进来，需要手动同步状态
- 产品上架时需要重复编写描述、设置价格
- 月底做报表时需要从多个系统导出数据再整合

这个技能把这些重复性工作自动化，让 Claude 能够：
1. 直接调用预置的脚本和工作流模板
2. 根据你的需求快速定制自动化流程
3. 减少重复编码，提高开发效率

## 核心组件

### 1. Wawi 连接器 (`scripts/wawi_connector.py`)

JTL-Wawi REST API 的 Python 客户端，特点：
- 自动处理 API 认证（App ID + API Key）
- 内置重试机制（网络超时、限流自动重试）
- 请求追踪（每个请求带唯一 Correlation ID）
- 批量操作支持

```python
from wawi_connector import WawiConnector, WawiConfig

# 从环境变量加载配置
config = WawiConfig.from_env()
connector = WawiConnector(config)

# 获取订单
orders = connector.get_orders(status="new")

# 更新库存
connector.update_stock(article_id=12345, stock_data={"available": 100})
```

### 2. 工作流引擎 (`scripts/workflow_engine.py`)

编排多步骤工作流的框架，特点：
- 步骤链式执行
- 上下文共享（步骤间传递数据）
- 错误处理（重试、跳过、中止三种策略）
- 状态持久化（可恢复中断的工作流）

```python
from workflow_engine import Workflow, FunctionStep

workflow = Workflow("daily-sync", fail_fast=False)
workflow.add_step(FunctionStep("fetch-data", fetch_data_func))
workflow.add_step(FunctionStep("process", process_func))
workflow.add_step(FunctionStep("notify", notify_func))

result = workflow.run({"date": "2024-01-15"})
```

### 3. 批处理器 (`scripts/batch_processor.py`)

并行处理大量数据的工具，特点：
- 多线程并行处理
- 自动分批（避免内存溢出）
- 进度追踪
- 单项失败不影响整体

```python
from batch_processor import BatchProcessor

processor = BatchProcessor(
    process_func=update_single_product,
    batch_size=100,
    max_workers=4,
    max_retries=3,
)

result = processor.process(products)
print(f"成功: {result.succeeded}, 失败: {result.failed}")
```

### 4. 通知发送器 (`scripts/notification_sender.py`)

多渠道通知系统，支持：
- 邮件（SMTP，支持 Turbo SMTP）
- Webhook（HTTP POST）
- Slack

```python
from notification_sender import NotificationSender, EmailChannel, NotificationMessage

sender = NotificationSender()
sender.add_channel(EmailChannel.from_env(["admin@eckstein.de"]))

sender.send(NotificationMessage(
    title="库存预警",
    body="5 个产品库存不足",
    level="warning",
))
```

## 工作流模板

技能包含四类预置工作流模板，详见 `references/` 目录：

| 文件 | 内容 |
|------|------|
| `order-workflows.md` | 订单导入、验证、履约、退货处理 |
| `inventory-workflows.md` | 库存同步、自动补货、供应商集成、预警 |
| `product-workflows.md` | 产品描述生成、渠道同步、分类、定价 |
| `reporting-workflows.md` | 日报/周报/月报、KPI、数据导出 |

## 环境变量配置

使用前需要设置以下环境变量：

```bash
# JTL-Wawi API
export JTL_WAWI_URL="https://your-wawi-server:port"
export JTL_WAWI_APP_ID="your-app-id"
export JTL_WAWI_API_KEY="your-api-key"

# 邮件通知（可选）
export SMTP_HOST="pro.turbo-smtp.com"
export SMTP_PORT="587"
export SMTP_USERNAME="your-username"
export SMTP_PASSWORD="your-password"
export SMTP_FROM="noreply@eckstein.de"

# Slack 通知（可选）
export SLACK_WEBHOOK_URL="https://hooks.slack.com/services/xxx"
```

## 快速开始

### 第一步：解压技能包

```bash
unzip jtl-workflow-automator.skill -d ./jtl-workflow-automator
cd jtl-workflow-automator
```

### 第二步：安装依赖

```bash
pip install requests openpyxl
```

### 第三步：测试连接

```python
from scripts.wawi_connector import WawiConnector, WawiConfig

config = WawiConfig(
    base_url="https://your-wawi-server:port",
    app_id="your-app-id",
    api_key="your-api-key",
)

connector = WawiConnector(config)
result = connector.get_articles(limit=5)
print(result)
```

### 第四步：运行示例工作流

```bash
python scripts/workflow_engine.py  # 运行演示工作流
python scripts/batch_processor.py  # 运行批处理演示
```

## 与现有系统集成

### 与 Dify 集成

可以将脚本封装为 Dify 的代码节点：

1. 在 Dify 工作流中添加「代码执行」节点
2. 将 `wawi_connector.py` 的核心类复制进去
3. 在后续节点中调用

### 与定时任务集成

使用 cron 或 systemd timer 定时执行：

```bash
# /etc/cron.d/jtl-workflows
0 6 * * * root python /opt/jtl-workflows/daily_stock_sync.py
0 7 * * * root python /opt/jtl-workflows/daily_report.py
0 8 * * 1 root python /opt/jtl-workflows/weekly_reorder.py
```

### 与 Appsmith 集成

在 Appsmith 中创建 API 数据源，调用你部署的工作流 API 端点。

## 故障排除

### 常见问题

**Q: API 连接超时**
A: 检查 `JTL_WAWI_URL` 是否正确，确保防火墙允许访问

**Q: 认证失败**
A: 确认 App 已在 JTL-Wawi 中注册并确认，API Key 正确

**Q: 批处理太慢**
A: 调整 `batch_size` 和 `max_workers` 参数，注意不要超过 API 限流

### 日志查看

工作流状态保存在 `/tmp/workflows/` 目录，可以查看执行历史：

```bash
cat /tmp/workflows/daily-sync-20240115-070000.json
```

## 扩展开发

如需添加新的工作流类型，按以下步骤：

1. 在 `references/` 中添加新的模板文档
2. 如需新脚本，添加到 `scripts/` 目录
3. 更新 `SKILL.md` 的描述，确保 Claude 知道新功能

## 支持

如有问题或建议，可以：
- 在对话中直接问 Claude
- 查阅 JTL-Wawi API 官方文档
- 参考 `references/` 中的详细工作流模板
